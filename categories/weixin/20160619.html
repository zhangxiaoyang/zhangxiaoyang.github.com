<!doctype html>
<html>
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta name="description" content="爱美工的程序员"/>
    <meta name="keywords" content="学习，思考，想法"/>
    <meta name="author" content="zhangxiaoyang"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
    <title>zhangxiaoyang.me</title>
    <link rel="shortcut icon" href="/favicon.ico"/>
    <link rel="stylesheet" type="text/css" href="/themes/default/css/style.css"/>
    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"/>
    <meta name="google-site-verification" content="Fjy6iUBWNJ0NBNFFzR8ZxFrkCxJ9rvHeBBYPyue-HBw"/>
<link rel="stylesheet" type="text/css" href="/themes/default/css/scrollUp.css"/>
<link rel="stylesheet" type="text/css" href="/themes/default/css/prettify-solarized-dark.css"/>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?661930a9db32b395d0caee1a2c022527";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-46826647-1', 'auto');
  ga('send', 'pageview');
</script>

  </head>
  <body>
    <div id="container">
      <div id="wrap">
        <header id="header">
          <div id="banner" style="background: url(http://ww3.sinaimg.cn/large/005X3nNxjw1epeyfkp54aj30sg0fr0tj.jpg) no-repeat center center; background-size: cover;">
          </div>
          <div id="header-outer" class="outer">
            <div id="header-title" class="inner">
              <div class="logo">
                <img src="https://avatars3.githubusercontent.com/u/2735163?v=3&amp;s=460" alt="Profile Picture">
              </div>
              <div id="title">
                爱美工的程序员
              </div>
              <ul class="my-navigation">
                
                <li>
                  <a href="/index.html" title="Home">
                  <i class="fa fa-home" style="color: #3369e8;"> </i>
                  </a>
                </li>
                
                <li>
                  <a href="/category.html" title="Category">
                  <i class="fa fa-th-large" style="color: #3369e8;"> </i>
                  </a>
                </li>
                
                <li>
                  <a href="/about.html" title="About">
                  <i class="fa fa-user" style="color: #3369e8;"> </i>
                  </a>
                </li>
                
                <li>
                  <a href="http://feed43.com/6303201812741414.xml" title="RSS">
                  <i class="fa fa-rss" style="color: #3369e8;"> </i>
                  </a>
                </li>
                
              </ul>
            </div>
          </div>
          <div id="header-inner" class="">
            <nav id="title-nav" style="display: none;">
              <span id="title-nav-items">
                
                  <a href="/index.html" title="Home">
                    <i class="fa fa-home"></i>
                  </a>
                
                  <a href="/category.html" title="Category">
                    <i class="fa fa-th-large"></i>
                  </a>
                
                  <a href="/about.html" title="About">
                    <i class="fa fa-user"></i>
                  </a>
                
                  <a href="http://feed43.com/6303201812741414.xml" title="RSS">
                    <i class="fa fa-rss"></i>
                  </a>
                
              </span>
            </nav>
            <nav id="sub-nav">
              <a id="nav-search-btn" class="nav-icon" title="Search">
              </a>
            </nav>
            <div id="search-form-wrap">
              <form action="http://www.baidu.com/baidu" method="get" accept-charset="utf-8"
              class="search-form">
                <input type="search" name="word" maxlength="20" class="search-form-input"
                placeholder="搜索">
                <input type="submit" value="" class="search-form-submit">
                <input name="tn" type="hidden" value="bds">
                <input name="cl" type="hidden" value="3">
                <input name="ct" type="hidden" value="2097152">
                <input type="hidden" name="si" value="zhangxiaoyang.me">
              </form>
            </div>
          </div>
        </header>

<div class="outer">
  <section id="main">
    <article id="weixin/20160619" class="article article-type-post"
    itemscope="" itemprop="blogPost">
      <div class="article-inner">
        <header class="article-header">
          <h1 itemprop="name">
            <a class="article-title" href="/categories/weixin/20160619.html">
              找寻微信撤回的图片
            </a>
          </h1>
        </header>
        <footer class="article-footer">
          <ul class="article-time-list">
            <li class="article-time-list-item">
              <a class="article-time-list-link" href="/archive.html">
                2016-06-19 12:50:00
              </a>
            </li>
          </ul>
          <br/>
          <ul class="article-category-list">
            <li class="article-category-list-item">
              <a class="article-category-list-link" href="/category.html">
                微信备份
              </a>
            </li>
          </ul>
          <br/>
          <ul class="article-tag-list">
            
              <li class="article-tag-list-item">
                <a class="article-tag-list-link" href="/tag.html">
                  微信撤回
                </a>
              </li>
            
          </ul>
        </footer>
        <div class="article-entry" itemprop="articleBody">
          <div class="article-abstract"><p><img src="/drafts/categories/weixin/images/kenan.jpg" alt=""></p>
<p>好奇心害死人啊。</p>
</div>
<h2 id="1-">1 消失的“艳”图</h2>
<p>自从微信添加撤回消息功能后，我的好奇心翻了好几番啊！</p>
<p>我们身边有一个逗比，暂且称他为胖胖，经常在朋友圈和微信群里说单口相声，内容以自黑为主，配图恰到好处。他乐观、奉献的精神深深的打动了我们。</p>
<p>前不久他在微信群里放出了一张聊天截图，肯定有料，但奈何他迅速撤回了。然后他在发送和撤回之间迭代，大家的好奇心被撩的不要不要的。最终通过其他渠道终于看到了那张图，治好了我的毕业综合症，心情美丽了好几天。</p>
<p>最近还发生了一起“消息撤回事件”，主人公爱生活，有梦想。具体来说是，力争把生活存成JPEG。对，无处不拍照，无景也能high！他丢过来一张“艳”图，当我准备鸡蛋里挑骨头的时候，他撤回了！心情是这样纸滴：<code>rm -rf /*</code>。</p>
<h2 id="2-">2 真相只有一个</h2>
<p>微信的消息撤回功能算是治疗输入法不够智能的一剂良药，但是却毁了生活中的一些小乐子啊。作为一名程序员，我忍无可忍了，柯南附体，必须找到那张消失的“艳”图。之前有听说Xposed框架里的防止微信撤回插件，更加坚定了我的信心。</p>
<p>因为当时刚好PC和手机同时登陆了微信，所以先从PC这里入手。</p>
<h3 id="2-1-pc-">2.1 PC端</h3>
<p>经过一番调研，把储存的位置锁定到了<code>[X]:\Users\[USER]\Documents\WeChat Files\[WECHAT_USER]\Data</code>。里面有一堆以<code>.dat</code>为后缀的文件，他们大小不一，其中最新的一个文件100多KB，我猜这应该就是要找的图片。</p>
<p>于是把后缀改为<code>.jpg</code>试试看，结果失败。果断给Notepad++装上HEX-Editor插件，秒变UltraEdit啊！为了找到图片的加密方法，随便找了一张图，发送过来，并到微信储存图片的位置找到最新的<code>.dat</code>文件，Notepad++打开是这样的（加密后的图片）：</p>
<p><img src="/drafts/categories/weixin/images/weixin-hex-encode.png" alt=""></p>
<p>在微信的客户端里右键另存为，把图片储存到本地，Notepad++打开是这样的（原始图片）：</p>
<p><img src="/drafts/categories/weixin/images/weixin-hex-decode.png" alt=""></p>
<p>可以很明显的看到，原始图片的<code>63 63 ...</code>变成了<code>32 32 ...</code>。猜测图片中的每一个字节经都经过了变换。为了方便寻找规律，找到原始图片的<code>00</code>，其对应加密后的图片的<code>51</code>，于是大胆猜测变换的方法是：`</p>
<pre><code>def encode(b):
    return b + 0x51
</code></pre><p>但是，<code>0x63 + 0x51</code>并不等于<code>0x32</code>。把16进制换成2进制再看一下：</p>
<pre><code>   0110 0011
?  0101 0001
--------------
   0011 0010
</code></pre><p>当两个1相加的时候并没有进位，所以这不是加法，而是半加，即异或！赶紧写代码试验一下：</p>
<pre><code class="lang-python">def _decode_pc_dat(self, datfile):
    magic = 0x51

    with open(datfile, &#39;rb&#39;) as f:
        buf = bytearray(f.read())

    imgfile = re.sub(r&#39;.dat$&#39;, &#39;.jpg&#39;, datfile)
    with open(imgfile, &#39;wb&#39;) as f:
        newbuf = bytearray(map(lambda b: b ^ magic, list(buf)))
        f.write(str(newbuf))
</code></pre>
<p>成功找到“艳”图。</p>
<h3 id="2-2-android-">2.2 手机端（Android）</h3>
<p>通过对微信路径里的文件逐一排查，最终找到了可疑的文件：<code>/sdcard/tencent/MicroMsg/diskcache</code>。该路径里的文件名称类似<code>cache.data.10</code>，大小在2MB左右。如果把后缀改为<code>.jpg</code>，是可以打开的。但是，疑点在于，2MB的图片，竟然马赛克浓度这么高，这充其量也就是才10几KB吧。而且，每一个文件都是2MB左右，人工的痕迹很明显啊。</p>
<p>能够打开图片，说明文件的内容是没有做任何修改的，文件头、文件尾都是非常正规的。难道，微信的工程师把多个图片串联了起来？！像这样：</p>
<pre><code>图片1的头部
图片1的尾部
图片2的头部
图片2的尾部
...
</code></pre><p>因为JPEG的文件是以<code>ff d8 ff e0</code>开始的，以<code>ff d9</code>结束，搜索一下：</p>
<p><img src="/drafts/categories/weixin/images/weixin-android-hex.png" alt=""></p>
<p>在一个图片的二进制中搜索到了多个文件头，且文件头的前面是一个文件尾标识，与猜测吻合。至此，可以写出解密方法了：</p>
<pre><code class="lang-python">def _decode_android_dat(self, datfile):
    with open(datfile, &#39;rb&#39;) as f:
        buf = f.read()

    last_index = 0
    for i, m in enumerate(re.finditer(b&#39;\xff\xd8\xff\xe0\x00\x10\x4a\x46&#39;, buf)):
        if m.start() == 0:
            continue

        imgfile = &#39;%s_%d.jpg&#39; % (datfile, i)
        with open(imgfile, &#39;wb&#39;) as f:
            f.write(buf[last_index: m.start()])
        last_index = m.start()
</code></pre>
<h2 id="3-0x51">3 神奇的0x51</h2>
<p>对于PC端图片的加密，工程师选择了一个神奇的数字<code>0x51</code>与各个字节进行异或。为什么要选择<code>0x51</code>呢？</p>
<pre><code class="lang-python">&gt;&gt;&gt; chr(0x51)
&#39;Q&#39;
</code></pre>
<p><code>0x51</code>对应的ASCII码为“QQ”的Q！</p>
<p>最后献上微信图片解密、找回撤回的图片工具： <a href="https://github.com/zhangxiaoyang/WechatImageDecoder">https://github.com/zhangxiaoyang/WechatImageDecoder</a>。</p>
<h2 id="-">参考</h2>
<ul>
<li><a href="http://image.kejixun.com/2015/0504/20150504034225444.jpg">http://image.kejixun.com/2015/0504/20150504034225444.jpg</a></li>
<li><a href="http://www.repo.xposed.info/">http://www.repo.xposed.info/</a></li>
<li><a href="https://www.zhihu.com/question/35056157">https://www.zhihu.com/question/35056157</a></li>
<li><a href="https://github.com/zhangxiaoyang/WechatImageDecoder">https://github.com/zhangxiaoyang/WechatImageDecoder</a></li>
</ul>

        </div>
        <div id="disqus_thread"></div>
      </div>
    </article>
  </section>
</div>
        <footer id="footer">
          <div class="outer">
            <div id="footer-info" class="inner">
              © 2017 zhangxiaoyang.me
              <br>
              Powered by
              <a href="https://github.com/zhangxiaoyang/fow" target="_blank">
                Fow
              </a>
            </div>
          </div>
        </footer>
      </div>
      <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.11.1/jquery.min.js" type="text/javascript"></script>
      <script src="/themes/default/js/jquery.scrollUp.min.js" type="text/javascript"></script>
      <script src="/themes/default/js/jquery.transform.js" type="text/javascript"></script>
      <script src="/themes/default/js/menu.js" type="text/javascript"></script>
      <script src="/themes/default/js/script.js" type="text/javascript"></script>
      <script src="/themes/default/js/scrollUp.js" type="text/javascript"></script>
      <script src="/themes/default/js/prettify.js" type="text/javascript"></script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
<script type="text/javascript">
$(window).load(function(){
  $('pre').addClass('prettyprint linenums');
  prettyPrint();
});
</script>

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],        
    inlineMath: [ ['$','$'], ['\\(','\\)'] ],
    displayMath: [ ['$$','$$'], ['\\[','\\]'] ]
  }
});
MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<script type="text/javascript">
  $('.article-entry img').click(function() {
    window.open($(this).attr('src'), '_blank');
  });
</script>

<script>
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = '//zhangxiaoyang-me.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

    </div>
  </body>
</html>

